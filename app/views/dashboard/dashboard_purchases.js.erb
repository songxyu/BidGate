
<%
	logger.debug "======= responded with rendered dashboard_purchases.js.erb ======"
	relative_path_arr = request.fullpath.split('/')
	ctrl_name = relative_path_arr[1] # params[:path]
 	action_name = relative_path_arr[2].split('?')[0]  # params[:action] 
	logger.debug "*** path controller_name= " + ctrl_name +", path action_name= " + action_name 
  	
  	default_partial_templ = 'my_purchases'
  	partial_template_path = default_partial_templ
  	if ctrl_name == 'dashboard'
  		partial_template_path = 
  		case action_name
  		when 'dashboard_purchases_all' then 'my_purchase_all_orders'
  		when 'dashboard_purchases_forpaid' then 'my_purchase_forpaid_orders'
  		when 'dashboard_purchases_complete' then 'my_purchase_complete_orders'
  		when 'dashboard_purchases_bidding' then 'my_purchase_bidding_orders'
  		else default_partial_templ
  	  	end
  	  	
  	  	logger.debug "*** partial_template_path: " + partial_template_path
  	end
  	
%>

var $dashboard_rightarea =  $(".content_area .dashboard-page .right-area");

<% if partial_template_path == default_partial_templ %>
$dashboard_rightarea.html("<%= escape_javascript render(:partial => 'dashboard/'+ partial_template_path ) %>");
<% else %>
$dashboard_rightarea.find('#<%=partial_template_path%>').html("<%= escape_javascript render(:partial => 'dashboard/'+ partial_template_path ) %>");
<% end %>


var afterAprroveBid = function(order_id, hist_id){
    alert('该订单已进入待付款状态');
    $('div[data-order-id="'+order_id+'"].panel').hide();
};


var $bidList = $dashboard_rightarea.find(".bid-hist-list");
var $radioButtons = $bidList.find('.price-hist-row');
console.log('$radioButtons rows count=', $radioButtons.length);

$radioButtons.on('click', '', function(){
    var $radioBtn = $(this).find('.radio-button-approve-vendor');
    $radioBtn.attr('checked', true);

	var $approveBtn = $(this).parents('.bid-hist-list').find('.btn-approve-area');
	console.log('$approveBtn count=', $approveBtn.length);
	$approveBtn.show();
	
	$approveBtn.unbind('click');
	$approveBtn.click(function(e){
        var $selectPriceHistRow = $(this).parents('.bid-hist-list').find('input[type="radio"]:checked');
        var order_id = $selectPriceHistRow.attr("data-orderid");
		var hist_id = $selectPriceHistRow.attr('data-histid');
		if(hist_id > 0){
			$.ajax({
				url : '/orders/approve_bid',
				type : 'put',
				dataType: 'json',  
				data : {
                    'order_id': order_id,
					'price_history_id' : hist_id
				}
			}).done(function(data) {
				console.log('hist_id = '+hist_id);
				afterAprroveBid(order_id, hist_id);
			}).fail(function(jqXHR, textStatus) {
				console.log("Request failed: " + JSON.stringify(textStatus));
			});
		}
		
	});
	
});  


 
 
var $arr_bid_progressbar = $dashboard_rightarea.find(".bid_progressbar");
$.each($arr_bid_progressbar, function(index, elem) {
	var prog_val = parseInt($(elem).data("progressval"));
	var bid_status = parseInt($(elem).data("status"));

	if (bid_status == 1 || bid_status == 0) {
		$(elem).css("height", "10px");
		$(elem).find(".ui-widget-header").css("height", "10px");
	}
	
	$(elem).progressbar({
		value : prog_val
	});
});





